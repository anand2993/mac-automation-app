trigger:
  - main

pool:
  vmImage: 'macOS-latest'

variables:
  imageName: 'mac-automation-app'
  composeFile: 'docker-compose.yml'

steps:
# Step 0: Install Docker on macOS
- script: |
    echo "Installing Docker Desktop for macOS..."
    brew install --cask docker
    
    echo "Starting Docker Desktop..."
    open -a Docker
    
    echo "Waiting for Docker to start..."
    while ! docker info > /dev/null 2>&1; do
      echo "Waiting for Docker daemon..."
      sleep 5
    done
    
    echo "‚úÖ Docker is ready"
    docker --version
    docker compose version
  displayName: 'üê≥ Install and Start Docker'

# Step 1: Show current state
- script: |
    echo "=== Current Running Containers ==="
    docker ps
    echo ""
    echo "=== Current Images ==="
    docker images | grep -E "mac-automation-app|prometheus|grafana|loki|promtail" || echo "No existing images"
  displayName: 'üìä Show Current State'
  continueOnError: true

# Step 2: Stop all containers
- script: |
    echo "Stopping all containers..."
    docker compose -f $(composeFile) down
    
    echo "Verifying containers are stopped..."
    docker ps -a | grep -E "mac-automation-app|prometheus|grafana|loki|promtail" || echo "All containers stopped"
  displayName: 'üõë Stop All Containers'
  continueOnError: true

# Step 3: Clean up old images (optional but recommended)
- script: |
    echo "Removing old application image..."
    docker rmi $(imageName)-web-app || echo "No old image to remove"
    
    echo "Pruning dangling images..."
    docker image prune -f
  displayName: 'üßπ Clean Up Old Images'
  continueOnError: true

# Step 4: Build new images
- script: |
    echo "Building Docker images with no cache..."
    docker compose -f $(composeFile) build --no-cache
    
    echo "=== Newly Built Images ==="
    docker images | grep mac-automation-app
  displayName: 'üî® Build Docker Images'

# Step 5: Verify build succeeded
- script: |
    echo "Verifying image was built..."
    docker images | grep mac-automation-app-web-app || exit 1
    echo "‚úÖ Image build verified"
  displayName: '‚úÖ Verify Build'

# Step 6: Start all containers
- script: |
    echo "Starting application stack..."
    docker compose -f $(composeFile) up -d
    
    echo "Waiting for containers to start..."
    sleep 10
  displayName: 'üöÄ Start All Containers'
  env:
    HOST_USER: $(HOST_USER)
    HOST_PASSWORD: $(HOST_PASSWORD)

# Step 7: Verify all containers are running
- script: |
    echo "=== Running Containers ==="
    docker ps
    
    echo ""
    echo "=== Verifying Container Status ==="
    
    # Check if all expected containers are running
    containers=("mac-automation-app" "prometheus" "grafana" "loki" "promtail")
    all_running=true
    
    for container in "${containers[@]}"; do
      if docker ps | grep -q "$container"; then
        echo "‚úÖ $container is running"
      else
        echo "‚ùå $container is NOT running"
        all_running=false
      fi
    done
    
    if [ "$all_running" = false ]; then
      echo "‚ö†Ô∏è  Some containers failed to start!"
      exit 1
    fi
    
    echo ""
    echo "‚úÖ All containers are running successfully!"
  displayName: '‚úÖ Verify All Containers Running'

# Step 8: Health checks
- script: |
    echo "=== Health Checks ==="
    
    echo "Waiting for services to be ready..."
    sleep 5
    
    # Check web app
    echo "Checking Web App (port 8080)..."
    curl -f http://localhost:8080 > /dev/null 2>&1 && echo "‚úÖ Web App is healthy" || echo "‚ö†Ô∏è  Web App health check failed"
    
    # Check Prometheus
    echo "Checking Prometheus (port 19090)..."
    curl -f http://localhost:19090/-/healthy > /dev/null 2>&1 && echo "‚úÖ Prometheus is healthy" || echo "‚ö†Ô∏è  Prometheus health check failed"
    
    # Check Grafana
    echo "Checking Grafana (port 3000)..."
    curl -f http://localhost:3000/api/health > /dev/null 2>&1 && echo "‚úÖ Grafana is healthy" || echo "‚ö†Ô∏è  Grafana health check failed"
    
    # Check Loki
    echo "Checking Loki (port 3100)..."
    curl -f http://localhost:3100/ready > /dev/null 2>&1 && echo "‚úÖ Loki is healthy" || echo "‚ö†Ô∏è  Loki health check failed"
    
    echo ""
    echo "‚úÖ Health checks completed"
  displayName: 'üè• Health Checks'
  continueOnError: true

# Step 9: Show container logs (for debugging)
- script: |
    echo "=== Recent Container Logs ==="
    echo ""
    echo "--- Web App Logs ---"
    docker logs mac-automation-app --tail 20
    echo ""
    echo "--- Prometheus Logs ---"
    docker logs prometheus --tail 10
    echo ""
    echo "--- Loki Logs ---"
    docker logs loki --tail 10
  displayName: 'üìù Show Container Logs'
  continueOnError: true

# Step 10: Verify logging configuration
- script: |
    echo "=== Verifying Log Configuration ==="
    docker inspect mac-automation-app | grep -A 5 "LogConfig"
    echo ""
    echo "‚úÖ Log rotation is configured (50MB limit)"
  displayName: 'üìä Verify Log Configuration'
  continueOnError: true

# Step 11: Final summary
- script: |
    echo "======================================"
    echo "üéâ DEPLOYMENT SUCCESSFUL!"
    echo "======================================"
    echo ""
    echo "Services accessible at:"
    echo "  ‚Ä¢ Web App:    http://localhost:8080"
    echo "  ‚Ä¢ Grafana:    http://localhost:3000"
    echo "  ‚Ä¢ Prometheus: http://localhost:19090"
    echo "  ‚Ä¢ Loki:       http://localhost:3100"
    echo ""
    echo "Container Status:"
    docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
    echo ""
    echo "======================================"
  displayName: 'üéâ Deployment Summary'
